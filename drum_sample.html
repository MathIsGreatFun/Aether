<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <title>Aether Instruments – Virtual Tongue Drum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts (same as site) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Bodoni+Moda:wght@500;700&display=swap" rel="stylesheet">

  <!-- Site styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- Mobile nav toggle -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toggle = document.querySelector(".nav-toggle");
      const nav = document.querySelector("nav.main-nav");
      if (!toggle || !nav) return;
      toggle.addEventListener("click", () => nav.classList.toggle("is-open"));
    });
  </script>

  <!-- Drum page styles (scoped) -->
  <style>
    .drum-page .content-card{ margin-top:18px }

    .drum-header{ margin-bottom:14px }
    .drum-title{
      font-family:"Bodoni Moda",serif;
      font-weight:700;
      margin:0 0 6px;
    }

    .drum-grid{
      display:grid;
      grid-template-columns:1.3fr .9fr;
      gap:16px;
    }
    @media (max-width:980px){
      .drum-grid{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:rgba(255,255,255,.75);
      backdrop-filter:blur(6px);
      padding:14px;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }

    .pill{
      border:1px solid rgba(0,0,0,.1);
      border-radius:999px;
      padding:7px 11px;
      font-size:12px;
      background:#fff;
      white-space:nowrap;
    }
    /* Glows when at 10/10 */
    .pill.full{
      background:linear-gradient(90deg, rgba(248,216,167,.9), #fff7ea);
      border-color:rgba(243,194,138,.85);
      box-shadow:0 0 0 1px rgba(243,194,138,.5);
    }

    .sep{height:1px;background:rgba(0,0,0,.08);margin:12px 0}

    /* Sustain row */
    .sustain-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .sustain-row .pill{
      padding-inline:9px;
    }
    .sustain-row input[type="range"]{
      flex:1 1 160px;
    }
    .sustain-label{
      font-size:12px;
      opacity:.8;
      white-space:nowrap;
    }

    .keys{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:8px;
    }
    .oct{margin:12px 0 8px;font-size:12px;opacity:.75}

    .key{
      border:1px solid rgba(0,0,0,.1);
      border-radius:12px;
      padding:10px;
      background:#fff;
      cursor:pointer;
      text-align:center;
      font-weight:500;
      font-family: Roboto, system-ui, sans-serif;
      transition:transform .06s, box-shadow .12s, border-color .12s;
      user-select:none;
    }
    .key:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(0,0,0,.08);
    }
    .key.sel{
      border-color:rgba(74,26,36,.35);
      box-shadow:
        0 0 0 2px rgba(243,194,138,.35) inset,
        0 10px 22px rgba(243,194,138,.18);
      background:linear-gradient(180deg, rgba(248,216,167,.6), #fff);
    }
    .key.flash{
      border-color:rgba(74,26,36,.35);
      box-shadow:
        0 0 0 2px rgba(243,194,138,.50) inset,
        0 12px 28px rgba(243,194,138,.35);
      background:linear-gradient(180deg, rgba(243,194,138,.55), #fff);
    }

    .drumWrap{
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:460px;
    }
    @media (max-width:600px){
      .drumWrap{
        min-height:380px;
      }
    }
    svg{max-width:100%; height:auto;}

    .tongue{cursor:pointer}
    .tongue.off{opacity:.25}
    .tongue.flash circle{
      fill:rgba(248,216,167,.85);
      stroke:rgba(243,194,138,.95);
      filter:drop-shadow(0 0 14px rgba(243,194,138,.55));
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      background:#fff;
      border:1px solid rgba(0,0,0,.1);
      border-radius:12px;
      padding:10px 12px;
      box-shadow:0 10px 26px rgba(0,0,0,.14);
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
      z-index:9999;
    }
    .toast.show{opacity:1}
  </style>
</head>

<body class="drum-page">
<header class="site-header">
  <div class="header-inner">
    <div class="logo-wrap">
      <img
        src="https://i0.wp.com/aetherinstruments.com/wp-content/uploads/2024/12/AetherIn.png?w=800&ssl=1"
        alt="Aether Instruments Logo">
    </div>

    <button class="nav-toggle" aria-label="Toggle navigation">☰ Menu</button>

    <nav class="main-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="shop.html">Shop</a></li>
        <li><a href="#" class="active">Virtual Drum</a></li>
        <li><a href="#">About</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
    </nav>
  </div>
</header>

<main>
  <section class="content-card">
    <div class="drum-header">
      <h2 class="drum-title">Virtual Tongue Drum</h2>
      <p>
        Please select up to 10 notes. Press numbers 1 through 0 on the keyboard,
        or tap on the tongues to play the corresponding notes.
      </p>
    </div>

    <div class="drum-grid">
      <div class="panel">
        <div class="controls">
          <span class="pill" id="countPill">Selected: 0 / 10</span>
          <button class="btn btn-ghost" id="clear" type="button">Clear</button>
          <button class="btn btn-primary" id="playSeq" type="button">Play 1→10</button>
          <button class="btn btn-ghost" id="transposeDown" type="button">Transpose -1</button>
          <button class="btn btn-ghost" id="transposeUp" type="button">Transpose +1</button>
          <button class="btn btn-ghost" id="copyLink" type="button">Copy share link</button>
        </div>

        <!-- Sustain control -->
        <div class="sustain-row">
          <span class="pill">Sustain</span>
          <input
            type="range"
            id="sustain"
            min="300"
            max="3000"
            step="100"
            value="1500"
          />
          <span class="sustain-label" id="sustainLabel">1.5 s</span>
        </div>

        <div class="sep"></div>
        <div id="picker"></div>
      </div>

      <div class="panel">
        <div class="drumWrap" id="drumHost"></div>
      </div>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="footer-inner">
    <span>&copy; <span id="year"></span> Aether Instruments. All rights reserved.</span>
    <span>Handcrafted in Arizona · <a href="#">Privacy Policy</a></span>
  </div>
</footer>

<div class="toast" id="toast">Copied!</div>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();
</script>

<script>
(() => {
  const MAX_NOTES = 10;

  // Chromatic notes (sharps only)
  const CHROMA = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const SEMI   = {"C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11};

  // RANGE: D3 .. B5  (C3 and C#3 excluded)
  const MIN_NOTE = "D3";
  const MAX_NOTE = "B5";

  // Pad 2..10 perimeter angles (from UP=0°, CCW+)
  const PERIM_ANGLES_UP_CCW = [200,160,240,120,280,80,320,40,0];

  function noteToMidi(n){
    const m = n.match(/^([A-G]#?)(\d)$/);
    return m ? ((Number(m[2])+1)*12 + SEMI[m[1]]) : null;
  }
  function midiToNote(m){
    const name = CHROMA[m % 12];
    const oct  = Math.floor(m / 12) - 1;
    return name + oct;
  }
  function minMidi(){ return noteToMidi(MIN_NOTE); }
  function maxMidi(){ return noteToMidi(MAX_NOTE); }

  // -----------------------------
  // WebAudio + polyphony limit + compressor
  // -----------------------------
  let audio = null;
  let masterGain = null;
  let compressor = null;

  const sampleCache = new Map(); // note -> AudioBuffer
  const MAX_VOICES = 8;
  const activeVoices = []; // BufferSource nodes

  // sustain in milliseconds (controlled by slider)
  let sustainMs = 1500;

  function ensureAudio(){
    if (!audio) {
      audio = new (window.AudioContext || window.webkitAudioContext)();

      masterGain = audio.createGain();
      masterGain.gain.value = 0.45;

      compressor = audio.createDynamicsCompressor();
      compressor.threshold.value = -18;
      compressor.knee.value = 24;
      compressor.ratio.value = 8;
      compressor.attack.value = 0.003;
      compressor.release.value = 0.15;

      masterGain.connect(compressor);
      compressor.connect(audio.destination);
    }
    if (audio.state === "suspended") audio.resume();
  }

  function sampleUrl(note){
    return "samples/" + encodeURIComponent(note) + ".mp3";
  }

  // Safari-friendly decodeAudioData (promise OR callback style)
  function decodeBuffer(arr){
    return new Promise((resolve, reject) => {
      try {
        if (audio.decodeAudioData.length === 1) {
          // Promise style
          audio.decodeAudioData(arr).then(resolve, reject);
        } else {
          // Old callback style (iOS Safari)
          audio.decodeAudioData(arr, resolve, reject);
        }
      } catch (e) {
        reject(e);
      }
    });
  }

  async function loadSample(note){
    if (sampleCache.has(note)) return sampleCache.get(note);
    ensureAudio();
    const url = sampleUrl(note);
    const res = await fetch(url);
    if (!res.ok) throw new Error("Missing sample: " + url);
    const arr = await res.arrayBuffer();
    const buf = await decodeBuffer(arr);
    sampleCache.set(note, buf);
    return buf;
  }

  async function playAudio(note){
    if (!note) return;
    ensureAudio();

    const buf = await loadSample(note);
    const now = audio.currentTime;

    const src = audio.createBufferSource();
    src.buffer = buf;

    const g = audio.createGain();
    const sustainSec = Math.min(sustainMs / 1000, buf.duration);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.linearRampToValueAtTime(1.0, now + 0.008);
    g.gain.linearRampToValueAtTime(0.0001, now + sustainSec);

    src.connect(g);
    g.connect(masterGain);

    activeVoices.push(src);
    src.onended = () => {
      const i = activeVoices.indexOf(src);
      if (i >= 0) activeVoices.splice(i, 1);
    };
    while (activeVoices.length > MAX_VOICES) {
      const oldest = activeVoices.shift();
      try { oldest.stop(); } catch {}
    }

    src.start(now);
    src.stop(now + buf.duration + 0.05);
  }

  // -----------------------------
  // Selection state (pads always sorted ascending frequency)
  // -----------------------------
  const selectedSet = new Set();
  let padNotes = []; // index 0..9 corresponds to pads 1..10

  function recomputePads(){
    padNotes = [...selectedSet]
      .sort((a,b) => (noteToMidi(a) ?? 1e9) - (noteToMidi(b) ?? 1e9))
      .slice(0, MAX_NOTES);
  }

  // -----------------------------
  // Toast + share link
  // -----------------------------
  const toastEl = document.getElementById("toast");

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(showToast._tm);
    showToast._tm = setTimeout(() => toastEl.classList.remove("show"), 1200);
  }

  function currentShareURL(){
    recomputePads();
    const u = new URL(location.href);
    if (padNotes.length) u.searchParams.set("notes", padNotes.join("-"));
    else u.searchParams.delete("notes");
    return u.toString();
  }

  async function copyShareLink(){
    const link = currentShareURL();
    try{
      await navigator.clipboard.writeText(link);
      showToast("Copied share link!");
    } catch {
      window.prompt("Copy this link:", link);
    }
  }

  // -----------------------------
  // Transpose (blocked if any note would clip)
  // -----------------------------
  function transposeSelection(semitones){
    if (!selectedSet.size) return;

    const arr = [...selectedSet].map(n => noteToMidi(n)).filter(m => m != null);
    const lo = minMidi();
    const hi = maxMidi();

    const wouldClip = arr.some(m => {
      const cand = m + semitones;
      return cand < lo || cand > hi;
    });
    if (wouldClip){
      showToast("Cannot transpose further in that direction.");
      return;
    }

    const newSet = new Set();
    arr.forEach(m => newSet.add(midiToNote(m + semitones)));

    selectedSet.clear();
    newSet.forEach(n => selectedSet.add(n));
    render();
  }

  // -----------------------------
  // Init from URL ?notes=D3-F#3-...
  // -----------------------------
  function initFromURL(){
    const qs = new URLSearchParams(location.search);
    const raw = qs.get("notes");
    if (!raw) return;

    const parts = raw.split(/[-,]/).map(s => s.trim()).filter(Boolean);

    selectedSet.clear();
    for (const n of parts){
      const m = noteToMidi(n);
      if (m == null) continue;
      if (m < minMidi() || m > maxMidi()) continue;
      selectedSet.add(n);
      if (selectedSet.size >= MAX_NOTES) break;
    }
  }

  // -----------------------------
  // UI: Picker
  // -----------------------------
  const picker = document.getElementById("picker");
  const drumHost = document.getElementById("drumHost");
  const countPill = document.getElementById("countPill");
  const sustainSlider = document.getElementById("sustain");
  const sustainLabel  = document.getElementById("sustainLabel");

  function updateSustainLabel(){
    const s = sustainMs / 1000;
    sustainLabel.textContent = s.toFixed(1) + " s";
  }

  if (sustainSlider) {
    sustainSlider.addEventListener("input", () => {
      const v = Number(sustainSlider.value);
      if (!Number.isNaN(v)) {
        sustainMs = v;
        updateSustainLabel();
      }
    });
    updateSustainLabel();
  }

  function buildPicker(){
    picker.innerHTML = "";
    for (let oct = 3; oct <= 5; oct++){
      const o = document.createElement("div");
      o.className = "oct";
      o.textContent = "Octave " + oct;
      picker.appendChild(o);

      const grid = document.createElement("div");
      grid.className = "keys";

      CHROMA.forEach(n => {
        const note = n + oct;
        const m = noteToMidi(note);

        if (m == null || m < minMidi() || m > maxMidi()) {
          grid.appendChild(document.createElement("div"));
          return;
        }

        const k = document.createElement("div");
        k.className = "key" + (selectedSet.has(note) ? " sel" : "");
        k.textContent = note;
        k.dataset.note = note;

        k.onclick = () => {
          ensureAudio();
          if (selectedSet.has(note)) selectedSet.delete(note);
          else if (selectedSet.size < MAX_NOTES) selectedSet.add(note);
          render();
        };

        grid.appendChild(k);
      });

      picker.appendChild(grid);
    }
  }

  // MOBILE-SAFE: no CSS.escape, just scan elements
  function flashKey(note){
    const keys = picker.querySelectorAll(".key");
    let el = null;
    for (const k of keys){
      if (k.dataset.note === note){
        el = k;
        break;
      }
    }
    if (!el) return;
    el.classList.add("flash");
    clearTimeout(el._flashTm);
    el._flashTm = setTimeout(() => el.classList.remove("flash"), 140);
  }

  // -----------------------------
  // Drum SVG (outer skin)
  // -----------------------------
  let tongues = null;

  function buildDrum(){
    const W = 520, cx = W/2, cy = W/2;

    const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("viewBox","0 0 520 520");

    const skin = document.createElementNS(svg.namespaceURI,"circle");
    skin.setAttribute("cx",cx);
    skin.setAttribute("cy",cy);
    skin.setAttribute("r",235);
    skin.setAttribute("fill","rgba(74,26,36,.06)");
    skin.setAttribute("stroke","rgba(74,26,36,.18)");
    skin.setAttribute("stroke-width","2");
    svg.appendChild(skin);

    const ring = document.createElementNS(svg.namespaceURI,"circle");
    ring.setAttribute("cx",cx);
    ring.setAttribute("cy",cy);
    ring.setAttribute("r",205);
    ring.setAttribute("fill","none");
    ring.setAttribute("stroke","rgba(74,26,36,.10)");
    ring.setAttribute("stroke-width","2");
    svg.appendChild(ring);

    const out = [];
    const rMid = 185;

    // Pad 1 center
    out.push({ pad:1, x:cx, y:cy });

    // Pads 2..10 around perimeter
    PERIM_ANGLES_UP_CCW.forEach((deg, i) => {
      const theta = deg * Math.PI / 180;
      const x = cx + rMid * Math.sin(theta);
      const y = cy - rMid * Math.cos(theta);
      out.push({ pad:i+2, x, y });
    });

    out.forEach(t => {
      const g = document.createElementNS(svg.namespaceURI,"g");
      g.classList.add("tongue");
      g.dataset.pad = String(t.pad);

      const circ = document.createElementNS(svg.namespaceURI,"circle");
      circ.setAttribute("cx", t.x);
      circ.setAttribute("cy", t.y);
      circ.setAttribute("r", t.pad === 1 ? 50 : 38);
      circ.setAttribute("fill","rgba(255,255,255,.92)");
      circ.setAttribute("stroke","rgba(74,26,36,.22)");
      circ.setAttribute("stroke-width","1.4");
      g.appendChild(circ);

      const lab = document.createElementNS(svg.namespaceURI,"text");
      lab.setAttribute("x", t.x);
      lab.setAttribute("y", t.y + 5);
      lab.setAttribute("text-anchor","middle");
      lab.setAttribute("font-family","Roboto, system-ui, sans-serif");
      lab.setAttribute("font-weight","700");
      lab.setAttribute("font-size","14");
      lab.setAttribute("fill","#55556d");
      g.appendChild(lab);

      g.onclick = async () => {
        ensureAudio();
        const n = padNotes[t.pad - 1];
        if (!n) return;
        await triggerPlay(n, t.pad);
      };

      t.el = g;
      t.lab = lab;
      svg.appendChild(g);
    });

    drumHost.innerHTML = "";
    drumHost.appendChild(svg);
    return out;
  }

  function syncDrum(){
    if (!tongues) tongues = buildDrum();
    tongues.forEach(t => {
      const n = padNotes[t.pad - 1];
      t.lab.textContent = n || "";
      t.el.classList.toggle("off", !n);
      t.lab.setAttribute("fill", n ? "#1d1d22" : "#55556d");
      t.lab.setAttribute("font-weight", n ? "800" : "700");
    });
  }

  function flashPad(pad){
    if (!tongues) return;
    const t = tongues.find(x => x.pad === pad);
    if (!t || !t.el) return;
    t.el.classList.add("flash");
    clearTimeout(t.el._flashTm);
    t.el._flashTm = setTimeout(() => t.el.classList.remove("flash"), 120);
  }

  async function triggerPlay(note, pad){
    flashPad(pad);
    flashKey(note);
    try { await playAudio(note); } catch (e) { console.warn(e); }
  }

  // -----------------------------
  // Keyboard mapping: 1..9 => pads 1..9, 0 => pad 10
  // (won't fire on mobile, but harmless)
  // -----------------------------
  window.addEventListener("keydown", async (e) => {
    const tag = (e.target && e.target.tagName || "").toLowerCase();
    if (tag === "input" || tag === "textarea") return;

    const k = e.key;
    let pad = null;
    if (k >= "1" && k <= "9") pad = Number(k);
    else if (k === "0") pad = 10;
    else return;

    const n = padNotes[pad - 1];
    if (!n) return;

    ensureAudio();
    await triggerPlay(n, pad);
  });

  // -----------------------------
  // Controls
  // -----------------------------
  document.getElementById("clear").onclick = () => {
    selectedSet.clear();
    render();
  };

  document.getElementById("playSeq").onclick = async () => {
    ensureAudio();
    recomputePads(); // ensure current pad order
    for (let i = 0; i < padNotes.length; i++){
      const note = padNotes[i];
      const pad = i + 1;
      await triggerPlay(note, pad);
      await new Promise(r => setTimeout(r, 220));
    }
  };

  document.getElementById("transposeDown").onclick = () => transposeSelection(-1);
  document.getElementById("transposeUp").onclick   = () => transposeSelection(1);
  document.getElementById("copyLink").onclick      = async () => { await copyShareLink(); };

  // -----------------------------
  // Render
  // -----------------------------
  function render(){
    recomputePads();
    countPill.textContent = `Selected: ${selectedSet.size} / 10`;
    countPill.classList.toggle("full", selectedSet.size === MAX_NOTES);
    buildPicker();
    syncDrum();
  }

  initFromURL();
  render();
})();
</script>

  function flashPad(pad){
    if (!tongues) return;
    const t = tongues.find(x => x.pad === pad);
    if (!t || !t.el) return;
    t.el.classList.add("flash");
    clearTimeout(t.el._flashTm);
    t.el._flashTm = setTimeout(() => t.el.classList.remove("flash"), 120);
  }

  async function triggerPlay(note, pad){
    flashPad(pad);
    flashKey(note);
    try { await playAudio(note); } catch (e) { console.warn(e); }
  }

  // -----------------------------
  // Keyboard mapping: 1..9 => pads 1..9, 0 => pad 10
  // -----------------------------
  window.addEventListener("keydown", async (e) => {
    const tag = (e.target && e.target.tagName || "").toLowerCase();
    if (tag === "input" || tag === "textarea") return;

    const k = e.key;
    let pad = null;
    if (k >= "1" && k <= "9") pad = Number(k);
    else if (k === "0") pad = 10;
    else return;

    const n = padNotes[pad - 1];
    if (!n) return;

    ensureAudio();
    await triggerPlay(n, pad);
  });

  // -----------------------------
  // Controls
  // -----------------------------
  document.getElementById("clear").onclick = () => {
    selectedSet.clear();
    render();
  };

  document.getElementById("playSeq").onclick = async () => {
    ensureAudio();
    recomputePads(); // ensure current pad order
    for (let i = 0; i < padNotes.length; i++){
      const note = padNotes[i];
      const pad = i + 1;
      await triggerPlay(note, pad);
      await new Promise(r => setTimeout(r, 220));
    }
  };

  document.getElementById("transposeDown").onclick = () => transposeSelection(-1);
  document.getElementById("transposeUp").onclick   = () => transposeSelection(1);
  document.getElementById("copyLink").onclick      = async () => { await copyShareLink(); };

  // -----------------------------
  // Render
  // -----------------------------
  function render(){
    recomputePads();
    countPill.textContent = `Selected: ${selectedSet.size} / 10`;
    countPill.classList.toggle("full", selectedSet.size === MAX_NOTES);
    buildPicker();
    syncDrum();
  }

  initFromURL();
  render();
})();
</script>
</body>
</html>
