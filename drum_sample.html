<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <title>Aether Instruments – Virtual Tongue Drum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts (same as site) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Bodoni+Moda:wght@500;700&display=swap" rel="stylesheet">

  <!-- Site styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- Mobile nav toggle -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toggle = document.querySelector(".nav-toggle");
      const nav = document.querySelector("nav.main-nav");
      if (!toggle || !nav) return;
      toggle.addEventListener("click", () => nav.classList.toggle("is-open"));
    });
  </script>

  <!-- Drum page styles (scoped) -->
  <style>
    .drum-page .content-card{ margin-top:18px }

    .drum-header{ margin-bottom:14px }
    .drum-title{
      font-family:"Bodoni Moda",serif;
      font-weight:700;
      margin:0 0 6px;
    }

    .drum-grid{
      display:grid;
      grid-template-columns:1.3fr .9fr;
      gap:16px;
    }
    @media (max-width:980px){
      .drum-grid{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:rgba(255,255,255,.75);
      backdrop-filter:blur(6px);
      padding:14px;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }

    .controls.presets-row{
      margin-top:4px;
      gap:8px;
    }

    .pill{
      border:1px solid rgba(0,0,0,.1);
      border-radius:999px;
      padding:7px 11px;
      font-size:12px;
      background:#fff;
      white-space:nowrap;
    }

    #presetSelect{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.1);
      font-size:13px;
      background:#fff;
      font-family:Roboto,system-ui,sans-serif;
    }

    .sep{height:1px;background:rgba(0,0,0,.08);margin:12px 0}

    .keys{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:8px;
    }
    .oct{margin:12px 0 8px;font-size:12px;opacity:.75}

    .key{
      border:1px solid rgba(0,0,0,.1);
      border-radius:12px;
      padding:10px;
      background:#fff;
      cursor:pointer;
      text-align:center;
      font-weight:500;
      font-family: Roboto, system-ui, sans-serif;
      transition:transform .06s, box-shadow .12s, border-color .12s;
      user-select:none;
    }
    .key:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(0,0,0,.08);
    }
    .key.sel{
      border-color:rgba(74,26,36,.35);
      box-shadow:
        0 0 0 2px rgba(243,194,138,.35) inset,
        0 10px 22px rgba(243,194,138,.18);
      background:linear-gradient(180deg, rgba(248,216,167,.6), #fff);
    }
    .key.flash{
      border-color:rgba(74,26,36,.35);
      box-shadow:
        0 0 0 2px rgba(243,194,138,.50) inset,
        0 12px 28px rgba(243,194,138,.35);
      background:linear-gradient(180deg, rgba(243,194,138,.55), #fff);
    }

    .drumWrap{
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:420px;
    }
    @media (max-width:600px){
      .drumWrap{
        min-height:360px;
      }
    }

    .drumSvg{
      max-width:100%;
      height:auto;
      display:block;
    }

    .tongue{cursor:pointer}
    .tongue.off{opacity:.25}
    .tongue.flash circle{
      fill:rgba(248,216,167,.85);
      stroke:rgba(243,194,138,.95);
      filter:drop-shadow(0 0 14px rgba(243,194,138,.55));
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      background:#fff;
      border:1px solid rgba(0,0,0,.1);
      border-radius:12px;
      padding:10px 12px;
      box-shadow:0 10px 26px rgba(0,0,0,.14);
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
      z-index:9999;
    }
    .toast.show{opacity:1}
  </style>
</head>

<body class="drum-page">
<header class="site-header">
  <div class="header-inner">
    <div class="logo-wrap">
      <img
        src="https://i0.wp.com/aetherinstruments.com/wp-content/uploads/2024/12/AetherIn.png?w=800&ssl=1"
        alt="Aether Instruments Logo">
    </div>

    <button class="nav-toggle" aria-label="Toggle navigation">☰ Menu</button>

    <nav class="main-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="shop.html">Shop</a></li>
        <li><a href="#" class="active">Virtual Drum</a></li>
        <li><a href="#">About</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
    </nav>
  </div>
</header>

<main>
  <section class="content-card">
    <div class="drum-header">
      <h2 class="drum-title">Virtual Tongue Drum</h2>
      <p>
        Please select up to 10 notes. Press numbers 1 through 0 on the keyboard,
        or tap on the tongues to play the corresponding notes.
      </p>
    </div>

    <div class="drum-grid">
      <div class="panel">
        <div class="controls">
          <span class="pill" id="countPill">Selected: 0 / 10</span>
          <button class="btn btn-ghost" id="clear" type="button">Clear</button>
          <button class="btn btn-primary" id="playSeq" type="button">Play 1→10</button>
          <button class="btn btn-ghost" id="transposeDown" type="button">Transpose -1</button>
          <button class="btn btn-ghost" id="transposeUp" type="button">Transpose +1</button>
          <button class="btn btn-ghost" id="copyLink" type="button">Copy share link</button>
        </div>

        <!-- Preset dropdown -->
        <div class="controls presets-row">
          <label for="presetSelect" class="pill">Preset scale:</label>
          <select id="presetSelect">
            <option value="">— Select a scale —</option>
          </select>
        </div>

        <div class="sep"></div>
        <div id="picker"></div>
      </div>

      <div class="panel">
        <div class="drumWrap" id="drumHost">
          <!-- INLINE SVG DRUM -->
          <svg viewBox="0 0 520 520" class="drumSvg">
            <defs>
              <radialGradient id="drumSkinGrad" cx="30%" cy="20%" r="80%">
                <stop offset="0%"  stop-color="rgba(248,216,167,0.98)"/>
                <stop offset="45%" stop-color="rgba(243,194,138,0.98)"/>
                <stop offset="100%" stop-color="rgba(74,26,36,0.98)"/>
              </radialGradient>
            </defs>

            <!-- Shell -->
            <circle cx="260" cy="260" r="235"
                    fill="url(#drumSkinGrad)"
                    stroke="rgba(0,0,0,0.35)"
                    stroke-width="2" />
            <circle cx="260" cy="260" r="205"
                    fill="none"
                    stroke="rgba(255,255,255,0.45)"
                    stroke-width="1.8" />

            <!-- Center tongue (pad 1) -->
            <g class="tongue" data-pad="1">
              <circle cx="260" cy="260" r="56"
                      fill="#fdf3dd"
                      stroke="rgba(74,26,36,0.7)"
                      stroke-width="2" />
              <text x="260" y="265"
                    text-anchor="middle"
                    font-family="Roboto, system-ui, sans-serif"
                    font-weight="700"
                    font-size="15"
                    fill="#4a1a24"></text>
            </g>

            <!-- Outer tongues pads 2..10 (pre-positioned) -->
            <!-- pad 2 -->
            <g class="tongue" data-pad="2">
              <circle cx="196.7" cy="433.8" r="44"
                      fill="#fdf3dd"
                      stroke="rgba(74,26,36,0.7)"
                      stroke-width="2" />
              <text x="196.7" y="438.8"
                    text-anchor="middle"
                    font-family="Roboto, system-ui, sans-serif"
                    font-weight="700"
                    font-size="15"
                    fill="#4a1a24"></text>
            </g>

            <!-- pad 3 -->
            <g class="tongue" data-pad="3">
              <circle cx="323.3" cy="433.8" r="44"
                      fill="#fdf3dd"
                      stroke="rgba(74,26,36,0.7)"
                      stroke-width="2" />
              <text x="323.3" y="438.8"
                    text-anchor="middle"
                    font-family="Roboto, system-ui, sans-serif"
                    font-weight="700"
                    font-size="15"
                    fill="#4a1a24"></text>
            </g>

            <!-- pad 4 -->
            <g class="tongue" data-pad="4">
              <circle cx="99.8" cy="352.5" r="44"
                      fill="#fdf3dd"
                      stroke="rgba(74,26,36,0.7)"
                      stroke-width="2" />
              <text x="99.8" y="357.5"
                    text-anchor="middle"
                    font-family="Roboto, system-ui, sans-serif"
                    font-weight="700"
                    font-size="15"
                    fill="#4a1a24"></text>
            </g>

            <!-- pad 5 -->
            <g class="tongue" data-pad="5">
              <circle cx="420.2" cy="352.5" r="44"
                      fill="#fdf3dd"
                      stroke="rgba(74,26,36,0.7)"
                      stroke-width="2" />
              <text x="420.2" y="357.5"
                    text-anchor="middle"
                    font-family="Roboto, system-ui, sans-serif"
                    font-weight="700"
                    font-size="15"
                    fill="#4a1a24"></text>
            </g>

            <!-- pad 6 -->
            <g class="tongue" data-pad="6">
              <circle cx="77.8" cy="227.9" r="44"
                      fill="#fdf3dd"
                      stroke="rgba(74,26,36,0.7)"
                      stroke-width="2" />
              <text x="77.8" y="232.9"
                    text-anchor="middle"
                    font-family="Roboto, system-ui, sans-serif"
                    font-weight="700"
                    font-size="15"
                    fill="#4a1a24"></text>
            </g>

            <!-- pad 7 -->
            <g class="tongue" data-pad="7">
              <circle cx="442.2" cy="227.9" r="44"
                      fill="#fdf3dd"
                      stroke="rgba(74,26,36,0.7)"
                      stroke-width="2" />
              <text x="442.2" y="232.9"
                    text-anchor="middle"
                    font-family="Roboto, system-ui, sans-serif"
                    font-weight="700"
                    font-size="15"
                    fill="#4a1a24"></text>
            </g>

            <!-- pad 8 -->
            <g class="tongue" data-pad="8">
              <circle cx="141.1" cy="118.3" r="44"
                      fill="#fdf3dd"
                      stroke="rgba(74,26,36,0.7)"
                      stroke-width="2" />
              <text x="141.1" y="123.3"
                    text-anchor="middle"
                    font-family="Roboto, system-ui, sans-serif"
                    font-weight="700"
                    font-size="15"
                    fill="#4a1a24"></text>
            </g>

            <!-- pad 9 -->
            <g class="tongue" data-pad="9">
              <circle cx="378.9" cy="118.3" r="44"
                      fill="#fdf3dd"
                      stroke="rgba(74,26,36,0.7)"
                      stroke-width="2" />
              <text x="378.9" y="123.3"
                    text-anchor="middle"
                    font-family="Roboto, system-ui, sans-serif"
                    font-weight="700"
                    font-size="15"
                    fill="#4a1a24"></text>
            </g>

            <!-- pad 10 -->
            <g class="tongue" data-pad="10">
              <circle cx="260" cy="75" r="44"
                      fill="#fdf3dd"
                      stroke="rgba(74,26,36,0.7)"
                      stroke-width="2" />
              <text x="260" y="80"
                    text-anchor="middle"
                    font-family="Roboto, system-ui, sans-serif"
                    font-weight="700"
                    font-size="15"
                    fill="#4a1a24"></text>
            </g>
          </svg>
        </div>
      </div>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="footer-inner">
    <span>&copy; <span id="year"></span> Aether Instruments. All rights reserved.</span>
    <span>Handcrafted in Arizona · <a href="#">Privacy Policy</a></span>
  </div>
</footer>

<div class="toast" id="toast">Copied!</div>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();
</script>

<script>
(() => {
  const MAX_NOTES = 10;

  // Chromatic notes (sharps only)
  const CHROMA = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const SEMI   = {"C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11};

  // RANGE: D3 .. B5  (C3 and C#3 excluded)
  const MIN_NOTE = "D3";
  const MAX_NOTE = "B5";

  function noteToMidi(n){
    const m = n.match(/^([A-G]#?)(\d)$/);
    return m ? ((Number(m[2])+1)*12 + SEMI[m[1]]) : null;
  }
  function midiToNote(m){
    const name = CHROMA[m % 12];
    const oct  = Math.floor(m / 12) - 1;
    return name + oct;
  }
  function minMidi(){ return noteToMidi(MIN_NOTE); }
  function maxMidi(){ return noteToMidi(MAX_NOTE); }

  // -----------------------------
  // WebAudio + polyphony limit + compressor
  // -----------------------------
  let audio = null;
  let masterGain = null;
  let compressor = null;

  const sampleCache = new Map(); // note -> AudioBuffer
  const MAX_VOICES = 8;
  const activeVoices = []; // BufferSource nodes

  const SUSTAIN_MS = 1500; // fixed sustain

  function ensureAudio(){
    if (!audio) {
      audio = new (window.AudioContext || window.webkitAudioContext)();

      masterGain = audio.createGain();
      masterGain.gain.value = 0.45;

      compressor = audio.createDynamicsCompressor();
      compressor.threshold.value = -18;
      compressor.knee.value = 24;
      compressor.ratio.value = 8;
      compressor.attack.value = 0.003;
      compressor.release.value = 0.15;

      masterGain.connect(compressor);
      compressor.connect(audio.destination);
    }
    if (audio.state === "suspended") audio.resume();
  }

  function sampleUrl(note){
    return "samples/" + encodeURIComponent(note) + ".mp3";
  }

  function decodeBuffer(arr){
    return new Promise((resolve, reject) => {
      try {
        if (audio.decodeAudioData.length === 1) {
          audio.decodeAudioData(arr).then(resolve, reject);
        } else {
          audio.decodeAudioData(arr, resolve, reject);
        }
      } catch (e) {
        reject(e);
      }
    });
  }

  async function loadSample(note){
    if (sampleCache.has(note)) return sampleCache.get(note);
    ensureAudio();
    const url = sampleUrl(note);
    const res = await fetch(url);
    if (!res.ok) throw new Error("Missing sample: " + url);
    const arr = await res.arrayBuffer();
    const buf = await decodeBuffer(arr);
    sampleCache.set(note, buf);
    return buf;
  }

  async function playAudio(note){
    if (!note) return;
    ensureAudio();

    const buf = await loadSample(note);
    const now = audio.currentTime;

    const src = audio.createBufferSource();
    src.buffer = buf;

    const g = audio.createGain();
    const sustainSec = Math.min(SUSTAIN_MS / 1000, buf.duration);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.linearRampToValueAtTime(1.0, now + 0.008);
    g.gain.linearRampToValueAtTime(0.0001, now + sustainSec);

    src.connect(g);
    g.connect(masterGain);

    activeVoices.push(src);
    src.onended = () => {
      const i = activeVoices.indexOf(src);
      if (i >= 0) activeVoices.splice(i, 1);
    };
    while (activeVoices.length > MAX_VOICES) {
      const oldest = activeVoices.shift();
      try { oldest.stop(); } catch {}
    }

    src.start(now);
    src.stop(now + buf.duration + 0.05);
  }

  // -----------------------------
  // Selection state
  // -----------------------------
  const selectedSet = new Set();
  let padNotes = []; // index 0..9 corresponds to pads 1..10

  function recomputePads(){
    padNotes = [...selectedSet]
      .sort((a,b) => (noteToMidi(a) ?? 1e9) - (noteToMidi(b) ?? 1e9))
      .slice(0, MAX_NOTES);
  }

  // -----------------------------
  // Toast + share link
  // -----------------------------
  const toastEl = document.getElementById("toast");

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(showToast._tm);
    showToast._tm = setTimeout(() => toastEl.classList.remove("show"), 1200);
  }

  function currentShareURL(){
    recomputePads();
    const u = new URL(location.href);
    if (padNotes.length) u.searchParams.set("notes", padNotes.join("-"));
    else u.searchParams.delete("notes");
    return u.toString();
  }

  async function copyShareLink(){
    const link = currentShareURL();
    try{
      await navigator.clipboard.writeText(link);
      showToast("Copied share link!");
    } catch {
      window.prompt("Copy this link:", link);
    }
  }

  // -----------------------------
  // Transpose
  // -----------------------------
  function transposeSelection(semitones){
    if (!selectedSet.size) return;

    const arr = [...selectedSet].map(n => noteToMidi(n)).filter(m => m != null);
    const lo = minMidi();
    const hi = maxMidi();

    const wouldClip = arr.some(m => {
      const cand = m + semitones;
      return cand < lo || cand > hi;
    });
    if (wouldClip){
      showToast("Cannot transpose further in that direction.");
      return;
    }

    const newSet = new Set();
    arr.forEach(m => newSet.add(midiToNote(m + semitones)));

    selectedSet.clear();
    newSet.forEach(n => selectedSet.add(n));
    render();
  }

  // -----------------------------
  // Init from URL ?notes=D3-F#3-...
  // -----------------------------
  function initFromURL(){
    const qs = new URLSearchParams(location.search);
    const raw = qs.get("notes");
    if (!raw) return;

    const parts = raw.split(/[-,]/).map(s => s.trim()).filter(Boolean);

    selectedSet.clear();
    for (const n of parts){
      const m = noteToMidi(n);
      if (m == null) continue;
      if (m < minMidi() || m > maxMidi()) continue;
      selectedSet.add(n);
      if (selectedSet.size >= MAX_NOTES) break;
    }
  }

  // -----------------------------
  // UI: Picker
  // -----------------------------
  const picker = document.getElementById("picker");
  const drumHost = document.getElementById("drumHost");
  const countPill = document.getElementById("countPill");

  function buildPicker(){
    picker.innerHTML = "";
    for (let oct = 3; oct <= 5; oct++){
      const o = document.createElement("div");
      o.className = "oct";
      o.textContent = "Octave " + oct;
      picker.appendChild(o);

      const grid = document.createElement("div");
      grid.className = "keys";

      CHROMA.forEach(n => {
        const note = n + oct;
        const m = noteToMidi(note);

        if (m == null || m < minMidi() || m > maxMidi()) {
          grid.appendChild(document.createElement("div"));
          return;
        }

        const k = document.createElement("div");
        k.className = "key" + (selectedSet.has(note) ? " sel" : "");
        k.textContent = note;
        k.dataset.note = note;

        k.onclick = () => {
          ensureAudio();
          if (selectedSet.has(note)) selectedSet.delete(note);
          else if (selectedSet.size < MAX_NOTES) selectedSet.add(note);
          render();
        };

        grid.appendChild(k);
      });

      picker.appendChild(grid);
    }
  }

  function flashKey(note){
    const keys = picker.querySelectorAll(".key");
    let el = null;
    for (const k of keys){
      if (k.dataset.note === note){
        el = k;
        break;
      }
    }
    if (!el) return;
    el.classList.add("flash");
    clearTimeout(el._flashTm);
    el._flashTm = setTimeout(() => el.classList.remove("flash"), 140);
  }

  // -----------------------------
  // Drum: use existing inline SVG
  // -----------------------------
  let tongues = [];

  function initDrumTongues(){
    const groups = drumHost.querySelectorAll(".tongue");
    tongues = [];
    groups.forEach(g => {
      const pad = Number(g.getAttribute("data-pad") || "0");
      const lab = g.querySelector("text");
      tongues.push({ pad, el:g, lab });

      g.onclick = async () => {
        ensureAudio();
        const n = padNotes[pad - 1];
        if (!n) return;
        await triggerPlay(n, pad);
      };
    });
  }

  function syncDrum(){
    if (!tongues.length) initDrumTongues();
    tongues.forEach(t => {
      const n = padNotes[t.pad - 1];
      t.lab.textContent = n || "";
      t.el.classList.toggle("off", !n);
    });
  }

  function flashPad(pad){
    if (!tongues.length) return;
    const t = tongues.find(x => x.pad === pad);
    if (!t || !t.el) return;
    t.el.classList.add("flash");
    clearTimeout(t.el._flashTm);
    t.el._flashTm = setTimeout(() => t.el.classList.remove("flash"), 120);
  }

  async function triggerPlay(note, pad){
    flashPad(pad);
    flashKey(note);
    try { await playAudio(note); } catch (e) { console.warn(e); }
  }

  // -----------------------------
  // Keyboard mapping
  // -----------------------------
  window.addEventListener("keydown", async (e) => {
    const tag = (e.target && e.target.tagName || "").toLowerCase();
    if (tag === "input" || tag === "textarea") return;

    const k = e.key;
    let pad = null;
    if (k >= "1" && k <= "9") pad = Number(k);
    else if (k === "0") pad = 10;
    else return;

    const n = padNotes[pad - 1];
    if (!n) return;

    ensureAudio();
    await triggerPlay(n, pad);
  });

  // -----------------------------
  // Presets (alphabetized)
  // -----------------------------
  const PRESETS = {
    "Aegean G":        ["G3","B3","D4","F#4","G4","B4","C#5","D5","F#5","B5"],
    "Akebono G":       ["G3","C4","D4","D#4","G4","G#4","C5","D5","D#5","G5"],
    "Celtic Minor G":  ["G3","D4","F4","G4","A4","A#4","C5","D5","F5","G5"],
    "Eunoia F":        ["F3","G3","G#3","A#3","C4","D#4","F4","G#4","A#4","C5"],
    "Harmonic Minor D":["D3","F3","G3","A3","A#3","C#4","D4","E4","F4","G4"],
    "Hijaz D":         ["D3","D#3","F#3","G3","A3","A#3","C4","D4","D#4","F#4"],
    "Iberian E":       ["E3","G#3","B3","D4","E4","F4","G#4","A4","B4","C5"],
    "Integral E":      ["E3","G3","B3","C4","D4","E4","F#4","G4","B4","C5"],
    "Kurd D":          ["D3","G3","A3","A#3","C4","D4","E4","F4","G4","A4","C5"],
    "Low Kaffa F":     ["F3","G#3","C4","C#4","E4","F4","G4","G#4","C5","F5"],
    "Low Pygmy F":     ["F3","G3","G#3","C4","D#4","F4","G4","G#4","C5","D#5"],
    "Major D":         ["D3","G3","A3","B3","C#4","D4","E4","F#4","A4","D5"],
    "Minor D":         ["D3","F3","A3","A#3","C4","D4","E4","F4","G4","A#4"],
    "Mystique G":      ["G3","D4","D#4","G4","A4","A#4","D5","D#5","F5","G5"],
    "North Sea D":     ["D3","E3","F3","A3","B3","C4","D4","E4","A4","B4"],
    "Paradise Dream F":["F3","G#3","A#3","D4","D#4","F4","G#4","A#4","D5","D#5"],
    "Pyramid F":       ["F3","A3","C4","D#4","F4","F#4","A4","A#4","C5","D#5"],
    "Sabye D":         ["D3","G3","A3","B3","C#4","D4","E4","F#4","A4","C#5"],
    "Serenity E":      ["E3","A3","B3","C#4","E4","F#4","A4","B4","C#5", "E5"],
    "Ursa Minor F":    ["F3","C4","C#4","F4","G4","G#4","A#4","C5","C#5","F5"],
    "Voyager D":       ["D3","F3","A3","C4","D4","E4","F4","A4","C5","D5"]
  };

  const presetSelect = document.getElementById("presetSelect");

  Object.keys(PRESETS).sort().forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    presetSelect.appendChild(opt);
  });

  function applyPreset(name){
    const notes = PRESETS[name];
    if (!notes) return;

    selectedSet.clear();

    for (const n of notes){
      const m = noteToMidi(n);
      if (m == null || m < minMidi() || m > maxMidi()) continue;
      selectedSet.add(n);
      if (selectedSet.size >= MAX_NOTES) break;
    }

    render();
  }

  presetSelect.addEventListener("change", () => {
    if (presetSelect.value)
      applyPreset(presetSelect.value);
  });

  // -----------------------------
  // Controls
  // -----------------------------
  document.getElementById("clear").onclick = () => {
    selectedSet.clear();
    presetSelect.value = "";
    render();
  };

  document.getElementById("playSeq").onclick = async () => {
    ensureAudio();
    recomputePads();
    for (let i = 0; i < padNotes.length; i++){
      const note = padNotes[i];
      const pad = i + 1;
      await triggerPlay(note, pad);
      await new Promise(r => setTimeout(r, 220));
    }
  };

  document.getElementById("transposeDown").onclick = () => transposeSelection(-1);
  document.getElementById("transposeUp").onclick   = () => transposeSelection(1);
  document.getElementById("copyLink").onclick      = async () => { await copyShareLink(); };

  // -----------------------------
  // Render
  // -----------------------------
  function render(){
    recomputePads();
    countPill.textContent = `Selected: ${selectedSet.size} / 10`;
    buildPicker();
    syncDrum();
  }

  initFromURL();
  initDrumTongues();
  render();
})();
</script>
</body>
</html>
