<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <title>Aether Instruments – Virtual Tongue Drum</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts (same as site) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Bodoni+Moda:wght@500;700&display=swap" rel="stylesheet">

  <!-- Site styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- Mobile nav toggle -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toggle = document.querySelector(".nav-toggle");
      const nav = document.querySelector("nav.main-nav");
      if (!toggle || !nav) return;
      toggle.addEventListener("click", () => nav.classList.toggle("is-open"));
    });
  </script>

  <!-- Drum page styles -->
  <style>
    .drum-page .content-card{ margin-top:18px }

    .drum-header{ margin-bottom:14px }
    .drum-title{
      font-family:"Bodoni Moda",serif;
      font-weight:700;
      margin:0 0 6px;
    }

    .drum-grid{
      display:grid;
      grid-template-columns:1.3fr .9fr;
      gap:16px;
    }
    @media (max-width:980px){
      .drum-grid{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      background:rgba(255,255,255,.75);
      backdrop-filter:blur(6px);
      padding:14px;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
    }

    .pill{
      border:1px solid rgba(0,0,0,.1);
      border-radius:999px;
      padding:7px 11px;
      font-size:12px;
      background:#fff;
    }

    .sep{height:1px;background:rgba(0,0,0,.08);margin:12px 0}

    .keys{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:8px;
    }
    .oct{margin:12px 0 8px;font-size:12px;opacity:.75}

    .key{
      border:1px solid rgba(0,0,0,.1);
      border-radius:12px;
      padding:10px;
      background:#fff;
      cursor:pointer;
      text-align:center;
      font-weight:500;
      transition:transform .06s, box-shadow .12s, border-color .12s;
    }
    .key:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(0,0,0,.08);
    }
    .key.sel{
      border-color:rgba(74,26,36,.35);
      box-shadow:
        0 0 0 2px rgba(243,194,138,.35) inset,
        0 10px 22px rgba(243,194,138,.18);
      background:linear-gradient(180deg, rgba(248,216,167,.6), #fff);
    }
    .key.flash{
      box-shadow:
        0 0 0 2px rgba(243,194,138,.5) inset,
        0 12px 28px rgba(243,194,138,.35);
    }

    .drumWrap{display:flex;justify-content:center;min-height:520px}
    svg{max-width:100%}

    .tongue{cursor:pointer}
    .tongue.off{opacity:.25}
    .tongue.flash circle{
      fill:rgba(248,216,167,.85);
      stroke:rgba(243,194,138,.95);
      filter:drop-shadow(0 0 14px rgba(243,194,138,.55));
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      background:#fff;
      border:1px solid rgba(0,0,0,.1);
      border-radius:12px;
      padding:10px 12px;
      box-shadow:0 10px 26px rgba(0,0,0,.14);
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
    }
    .toast.show{opacity:1}
  </style>
</head>

<body class="drum-page">
<header class="site-header">
  <div class="header-inner">
    <div class="logo-wrap">
      <img src="https://i0.wp.com/aetherinstruments.com/wp-content/uploads/2024/12/AetherIn.png?w=800&ssl=1" alt="Aether Instruments Logo">
    </div>
    <button class="nav-toggle">☰ Menu</button>
    <nav class="main-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="shop.html">Shop</a></li>
        <li><a href="#" class="active">Virtual Drum</a></li>
      </ul>
    </nav>
  </div>
</header>

<main>
<section class="content-card">
  <div class="drum-header">
    <h2 class="drum-title">Virtual Tongue Drum</h2>
    <p>Please select 10 notes. Press numbers 1–0 or click pads to play.</p>
  </div>

  <div class="drum-grid">
    <div class="panel">
      <div class="controls">
        <span class="pill" id="countPill">Selected: 0 / 10</span>
        <button class="btn btn-ghost" id="clear">Clear</button>
        <button class="btn btn-primary" id="playSeq">Play 1→10</button>
        <button class="btn btn-ghost" id="transposeDown">Transpose -1</button>
        <button class="btn btn-ghost" id="transposeUp">Transpose +1</button>
        <button class="btn btn-ghost" id="copyLink">Copy share link</button>
      </div>
      <div class="sep"></div>
      <div id="picker"></div>
    </div>

    <div class="panel">
      <div class="drumWrap" id="drumHost"></div>
    </div>
  </div>
</section>
</main>

<footer class="site-footer">
  <div class="footer-inner">
    <span>&copy; <span id="year"></span> Aether Instruments</span>
  </div>
</footer>

<div class="toast" id="toast">Copied!</div>

<script>
document.getElementById("year").textContent=new Date().getFullYear();

(() => {
  const MAX_NOTES=10;
  const CHROMA=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const SEMI={C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11};
  const MIN_NOTE="D3", MAX_NOTE="B5";
  const PERIM=[200,160,240,120,280,80,320,40,0];

  const selectedSet=new Set();
  let padNotes=[], tongues=null;

  function noteToMidi(n){const m=n.match(/^([A-G]#?)(\d)$/);return m?((+m[2]+1)*12+SEMI[m[1]]):null}
  function midiToNote(m){return CHROMA[m%12]+(Math.floor(m/12)-1)}
  function minMidi(){return noteToMidi(MIN_NOTE)}
  function maxMidi(){return noteToMidi(MAX_NOTE)}

  let audio=null, masterGain=null, compressor=null;
  const cache=new Map(), MAX_VOICES=8, voices=[];

  function ensureAudio(){
    if(!audio){
      audio=new AudioContext();
      masterGain=audio.createGain(); masterGain.gain.value=.45;
      compressor=audio.createDynamicsCompressor();
      masterGain.connect(compressor); compressor.connect(audio.destination);
    }
    if(audio.state==="suspended")audio.resume();
  }

  function url(n){return "samples/"+encodeURIComponent(n)+".mp3"}
  async function load(n){
    if(cache.has(n))return cache.get(n);
    ensureAudio();
    const b=await (await fetch(url(n))).arrayBuffer();
    const buf=await audio.decodeAudioData(b);
    cache.set(n,buf); return buf;
  }

  async function play(n,pad){
    ensureAudio();
    const buf=await load(n), now=audio.currentTime;
    const s=audio.createBufferSource(), g=audio.createGain();
    s.buffer=buf;
    g.gain.setValueAtTime(.001,now);
    g.gain.linearRampToValueAtTime(1,now+.01);
    g.gain.linearRampToValueAtTime(.001,now+Math.min(1.8,buf.duration));
    s.connect(g); g.connect(masterGain);
    voices.push(s); while(voices.length>MAX_VOICES)voices.shift().stop();
    s.start(); s.stop(now+buf.duration+.05);
    flashPad(pad); flashKey(n);
  }

  function recompute(){padNotes=[...selectedSet].sort((a,b)=>noteToMidi(a)-noteToMidi(b)).slice(0,10)}

  const picker=document.getElementById("picker");
  function buildPicker(){
    picker.innerHTML="";
    for(let o=3;o<=5;o++){
      picker.insertAdjacentHTML("beforeend",`<div class="oct">Octave ${o}</div>`);
      const g=document.createElement("div"); g.className="keys";
      CHROMA.forEach(c=>{
        const n=c+o,m=noteToMidi(n);
        if(m<minMidi()||m>maxMidi()){g.appendChild(document.createElement("div"));return}
        const k=document.createElement("div");
        k.className="key"+(selectedSet.has(n)?" sel":"");
        k.textContent=n; k.dataset.note=n;
        k.onclick=()=>{selectedSet.has(n)?selectedSet.delete(n):selectedSet.size<10&&selectedSet.add(n); render()}
        g.appendChild(k);
      });
      picker.appendChild(g);
    }
  }

  function buildDrum(){
    const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("viewBox","0 0 520 520");
    const cx=260,cy=260,r=185;
    const pads=[{pad:1,x:cx,y:cy}];
    PERIM.forEach((d,i)=>{
      const t=d*Math.PI/180;
      pads.push({pad:i+2,x:cx+r*Math.sin(t),y:cy-r*Math.cos(t)});
    });
    pads.forEach(p=>{
      const g=document.createElementNS(svg.namespaceURI,"g");
      g.classList.add("tongue"); g.dataset.pad=p.pad;
      const c=document.createElementNS(svg.namespaceURI,"circle");
      c.setAttribute("cx",p.x);c.setAttribute("cy",p.y);
      c.setAttribute("r",p.pad===1?50:38);
      c.setAttribute("fill","rgba(255,255,255,.9)");
      c.setAttribute("stroke","rgba(74,26,36,.25)");
      c.setAttribute("stroke-width","1.4");
      g.appendChild(c);
      const t=document.createElementNS(svg.namespaceURI,"text");
      t.setAttribute("x",p.x);t.setAttribute("y",p.y+5);
      t.setAttribute("text-anchor","middle");
      g.appendChild(t);
      g.onclick=()=>{const n=padNotes[p.pad-1];if(n)play(n,p.pad)}
      svg.appendChild(g);
      p.el=g; p.lab=t;
    });
    document.getElementById("drumHost").appendChild(svg);
    return pads;
  }

  function sync(){
    if(!tongues)tongues=buildDrum();
    tongues.forEach(t=>{
      const n=padNotes[t.pad-1];
      t.lab.textContent=n||"";
      t.el.classList.toggle("off",!n);
    });
  }

  function flashPad(p){
    const t=tongues?.find(x=>x.pad===p); if(!t)return;
    t.el.classList.add("flash");
    setTimeout(()=>t.el.classList.remove("flash"),120);
  }
  function flashKey(n){
    const k=picker.querySelector(`.key[data-note="${CSS.escape(n)}"]`);
    if(!k)return;
    k.classList.add("flash");
    setTimeout(()=>k.classList.remove("flash"),140);
  }

  window.addEventListener("keydown",e=>{
    const p=e.key==="0"?10:+e.key;
    if(p>=1&&p<=10&&padNotes[p-1])play(padNotes[p-1],p);
  });

  function render(){
    recompute();
    document.getElementById("countPill").textContent=`Selected: ${selectedSet.size} / 10`;
    buildPicker(); sync();
  }

  render();
})();
</script>
</body>
</html>
