name: Update Etsy Listings

on:
  schedule:
    # Run once a day at 9:00 UTC
    - cron: "0 9 * * *"
  workflow_dispatch:       # lets you run it manually from the Actions tab

jobs:
  update-listings:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm install node-fetch@3

      - name: Fetch Etsy listings
        env:
          ETSY_API_KEYSTRING: ${{ secrets.ETSY_API_KEYSTRING }}
          ETSY_SHOP_ID: ${{ secrets.ETSY_SHOP_ID }}
        run: |
                - name: Fetch Etsy listings
        env:
          ETSY_API_KEYSTRING: ${{ secrets.ETSY_API_KEYSTRING }}
          ETSY_SHARED_SECRET: ${{ secrets.ETSY_SHARED_SECRET }}
          ETSY_SHOP_ID: ${{ secrets.ETSY_SHOP_ID }}
        run: |
          node << 'EOF'
          import fetch from "node-fetch";
          import { writeFileSync, mkdirSync } from "fs";

          const apiKey = process.env.ETSY_API_KEYSTRING;
          const sharedSecret = process.env.ETSY_SHARED_SECRET;
          const shopId = process.env.ETSY_SHOP_ID;

          if (!apiKey || !shopId) {
            console.error("Missing ETSY_API_KEYSTRING or ETSY_SHOP_ID");
            process.exit(1);
          }

          // Use keystring:shared_secret if we have a shared secret, otherwise just keystring
          const headers = {
            "x-api-key": sharedSecret ? `${apiKey}:${sharedSecret}` : apiKey,
            "Content-Type": "application/json",
          };

          async function fetchJson(url) {
            const res = await fetch(url, { headers });
            if (!res.ok) {
              console.error("Etsy API error:", res.status, await res.text());
              process.exit(1);
            }
            return res.json();
          }

          function formatMoney(money) {
            if (!money || typeof money !== "object") {
              return { price: null, currency_code: null };
            }
            const amount = Number(money.amount);
            const divisor = Number(money.divisor || 100);
            const currency_code = money.currency_code || null;

            if (Number.isNaN(amount) || Number.isNaN(divisor) || divisor === 0) {
              return { price: null, currency_code };
            }

            const value = amount / divisor;
            return {
              price: value.toFixed(2),
              currency_code,
            };
          }

          async function main() {
            // 1) Get active listings (to get listing_ids)
            const activeUrl =
              `https://openapi.etsy.com/v3/application/shops/${shopId}/listings/active?limit=100`;
            const activeData = await fetchJson(activeUrl);
            const activeResults = Array.isArray(activeData)
              ? activeData
              : (activeData.results || []);

            const listingIds = activeResults
              .map((l) => l.listing_id)
              .filter((id) => !!id);

            if (listingIds.length === 0) {
              console.log("No active listings found.");
              mkdirSync("data", { recursive: true });
              writeFileSync("data/etsy-listings.json", "[]");
              return;
            }

            // 2) Get full listing data + images in one batch call
            const batchUrl =
              `https://openapi.etsy.com/v3/application/listings/batch` +
              `?includes=Images&listing_ids=${listingIds.join(",")}`;

            const batchData = await fetchJson(batchUrl);
            const items = Array.isArray(batchData)
              ? batchData
              : (batchData.results || []);

            const simplified = items.map((item) => {
              const { price, currency_code } = formatMoney(item.price);

              const primaryImage =
                item.images &&
                item.images[0] &&
                item.images[0].url_fullxfull
                  ? item.images[0].url_fullxfull
                  : null;

              return {
                listing_id: item.listing_id,
                title: item.title,
                description: item.description,
                url: item.url,
                price,
                currency_code,
                primary_image: primaryImage,
              };
            });

            mkdirSync("data", { recursive: true });
            writeFileSync(
              "data/etsy-listings.json",
              JSON.stringify(simplified, null, 2)
            );
            console.log(`Wrote ${simplified.length} listings to data/etsy-listings.json`);
          }

          main().catch((err) => {
            console.error(err);
            process.exit(1);
          });
          EOF


      - name: Commit and push updated JSON
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add data/etsy-listings.json
            git commit -m "Update Etsy listings"
            git push
          else
            echo "No changes to commit."
          fi
