name: Update Etsy Listings

on:
  schedule:
    - cron: "0 9 * * *"   # once per day at 09:00 UTC
  workflow_dispatch:       # allow manual runs

permissions:
  contents: write          # allow pushing commits

jobs:
  update-listings:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm install node-fetch@3

      - name: Fetch Etsy listings
        env:
          ETSY_API_KEYSTRING: ${{ secrets.ETSY_API_KEYSTRING }}
          ETSY_SHARED_SECRET: ${{ secrets.ETSY_SHARED_SECRET }}
          ETSY_SHOP_ID: ${{ secrets.ETSY_SHOP_ID }}
        run: |
          node << 'EOF'
          import fetch from "node-fetch";
          import { writeFileSync, mkdirSync } from "fs";

          const apiKey = process.env.ETSY_API_KEYSTRING;
          const sharedSecret = process.env.ETSY_SHARED_SECRET;
          const shopId = process.env.ETSY_SHOP_ID;

          if (!apiKey || !shopId) {
            console.error("Missing ETSY_API_KEYSTRING or ETSY_SHOP_ID");
            process.exit(1);
          }

          const headers = {
            "x-api-key": sharedSecret ? `${apiKey}:${sharedSecret}` : apiKey,
            "Content-Type": "application/json",
          };

          async function fetchJson(url) {
            const res = await fetch(url, { headers });
            if (!res.ok) {
              console.error("Etsy API error:", res.status, await res.text());
              process.exit(1);
            }
            return res.json();
          }

          // Fix common HTML entity encodings from Etsy (including double-escaped)
          function decodeEntities(str) {
            if (!str) return "";
            let s = String(str);

            // Handle double-escaped &amp;quot;, numeric forms, etc.
            s = s.replace(/&amp;quot;/g, '"');
            s = s.replace(/&quot;/g, '"');
            s = s.replace(/&#34;/g, '"');
            s = s.replace(/&amp;#34;/g, '"');

            s = s.replace(/&amp;apos;/g, "'");
            s = s.replace(/&apos;/g, "'");
            s = s.replace(/&#39;/g, "'");
            s = s.replace(/&amp;#39;/g, "'");

            // You can add more replacements here if Etsy uses other entities

            return s;
          }

          function formatMoney(money) {
            if (!money || typeof money !== "object") {
              return { price: null, currency_code: null };
            }
            const amount = Number(money.amount);
            const divisor = Number(money.divisor || 100);
            const currency_code = money.currency_code || null;
            if (Number.isNaN(amount) || Number.isNaN(divisor) || divisor === 0) {
              return { price: null, currency_code };
            }
            return {
              price: (amount / divisor).toFixed(2),
              currency_code,
            };
          }

          async function main() {
            // 1) Get active listing IDs
            const activeUrl =
              `https://openapi.etsy.com/v3/application/shops/${shopId}/listings/active?limit=100`;
            const activeData = await fetchJson(activeUrl);
            const activeResults = Array.isArray(activeData)
              ? activeData
              : (activeData.results || []);
            const listingIds = activeResults.map(l => l.listing_id).filter(Boolean);

            if (!listingIds.length) {
              mkdirSync("data", { recursive: true });
              writeFileSync("data/etsy-listings.json", "[]");
              console.log("No listings found.");
              return;
            }

            // 2) Fetch listings WITH images
            const batchUrl =
              `https://openapi.etsy.com/v3/application/listings/batch` +
              `?includes=Images&listing_ids=${listingIds.join(",")}`;
            const batchData = await fetchJson(batchUrl);
            const items = Array.isArray(batchData)
              ? batchData
              : (batchData.results || []);

            const simplified = items.map(item => {
              const { price, currency_code } = formatMoney(item.price);
              const primaryImage =
                item.images &&
                item.images[0] &&
                item.images[0].url_fullxfull
                  ? item.images[0].url_fullxfull
                  : null;

              const title = decodeEntities(item.title || "");
              const description = decodeEntities(item.description || "");

              return {
                listing_id: item.listing_id,
                title,
                description,
                url: item.url,
                price,
                currency_code,
                primary_image: primaryImage,
              };
            });

            mkdirSync("data", { recursive: true });
            writeFileSync(
              "data/etsy-listings.json",
              JSON.stringify(simplified, null, 2)
            );
            console.log(`Wrote ${simplified.length} listings.`);
          }

          main().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - name: Commit and push updated JSON
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add data/etsy-listings.json
            git commit -m "Update Etsy listings"
            git push
          else
            echo "No changes to commit."
          fi
