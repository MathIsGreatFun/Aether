<script>
  // Safely decode HTML entities (handles double-escaped text too)
  function decodeHtml(html) {
    if (!html) return "";
    const txt = document.createElement("textarea");
    let prev = html;
    let curr = html;

    do {
      prev = curr;
      txt.innerHTML = prev;
      curr = txt.value;
    } while (curr !== prev);   // stop when decoding no longer changes it

    return curr;
  }

  async function loadListings() {
    const errorDiv = document.getElementById("error");
    const container = document.getElementById("listings-container");

    errorDiv.textContent = "";
    container.textContent = "Loading listingsâ€¦";

    try {
      // Load JSON generated by GitHub Actions
      const res = await fetch("data/etsy-listings.json?" + Date.now());

      if (!res.ok) throw new Error("Failed to fetch listings");

      const listings = await res.json();

      if (!Array.isArray(listings) || listings.length === 0) {
        container.textContent = "No active listings found.";
        return;
      }

      container.innerHTML = "";

      listings.forEach((item) => {
        const card = document.createElement("div");
        card.className = "listing-card";

        // ---- Image ----
        const imageWrapper = document.createElement("div");
        imageWrapper.className = "listing-image-wrapper";

        if (item.primary_image) {
          const img = document.createElement("img");
          img.src = item.primary_image;
          img.alt = decodeHtml(item.title || "Etsy listing");
          imageWrapper.appendChild(img);
        } else {
          imageWrapper.textContent = "No image";
        }

        card.appendChild(imageWrapper);

        // ---- Title ----
        const title = document.createElement("div");
        title.className = "listing-title";
        title.textContent = decodeHtml(item.title || "Untitled listing");
        card.appendChild(title);

        // ---- Price ----
        const price = document.createElement("div");
        price.className = "listing-price";

        if (item.price) {
          const currency = item.currency_code || "";
          price.textContent = `${item.price} ${currency}`.trim();
        } else {
          price.textContent = "Price unavailable";
        }

        card.appendChild(price);

        // ---- Etsy link ----
        if (item.url) {
          const link = document.createElement("a");
          link.className = "listing-link";
          link.href = item.url;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = "View on Etsy";
          card.appendChild(link);
        }

        container.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      errorDiv.textContent = "Error loading Etsy listings.";
      container.textContent = "";
    }
  }

  loadListings();
</script>
