<script>
  // Decode HTML entities, plus aggressively normalize common ones like &quot;
  function decodeHtml(html) {
    if (!html) return "";
    let s = String(html);

    // Manual fixes for common patterns (covers many weird cases)
    s = s.replace(/&amp;quot;/g, '"'); // &amp;quot; -> "
    s = s.replace(/&quot;/g, '"');    // &quot;    -> "
    s = s.replace(/&#34;/g, '"');     // numeric double-quote
    s = s.replace(/&apos;/g, "'");    // &apos;    -> '
    s = s.replace(/&#39;/g, "'");     // numeric single-quote

    // Generic HTML decode loop, in case there are other entities
    const txt = document.createElement("textarea");
    let prev = s;
    let curr = s;

    do {
      prev = curr;
      txt.innerHTML = prev;
      curr = txt.value;
    } while (curr !== prev); // stop when decoding no longer changes it

    return curr;
  }

  async function loadListings() {
    const errorDiv = document.getElementById("error");
    const container = document.getElementById("listings-container");

    errorDiv.textContent = "";
    container.textContent = "Loading listingsâ€¦";

    try {
      // Load JSON generated by GitHub Actions
      const res = await fetch("data/etsy-listings.json?" + Date.now());

      if (!res.ok) throw new Error("Failed to fetch listings");

      const listings = await res.json();

      if (!Array.isArray(listings) || listings.length === 0) {
        container.textContent = "No active listings found.";
        return;
      }

      container.innerHTML = "";

      listings.forEach((item) => {
        const card = document.createElement("div");
        card.className = "listing-card";

        // ---- Image ----
        const imageWrapper = document.createElement("div");
        imageWrapper.className = "listing-image-wrapper";

        if (item.primary_image) {
          const img = document.createElement("img");
          img.src = item.primary_image;
          img.alt = decodeHtml(item.title || "Etsy listing");
          imageWrapper.appendChild(img);
        } else {
          imageWrapper.textContent = "No image";
        }

        card.appendChild(imageWrapper);

        // ---- Title ----
        const title = document.createElement("div");
        title.className = "listing-title";
        title.textContent = decodeHtml(item.title || "Untitled listing");
        card.appendChild(title);

        // ---- (Optional) Description ----
        // If you want the description visible, uncomment this block:
        /*
        if (item.description) {
          const desc = document.createElement("div");
          desc.className = "listing-description";
          desc.textContent = decodeHtml(item.description);
          card.appendChild(desc);
        }
        */

        // ---- Price ----
        const price = document.createElement("div");
        price.className = "listing-price";

        if (item.price) {
          const currency = item.currency_code || "";
          price.textContent = `${item.price} ${currency}`.trim();
        } else {
          price.textContent = "Price unavailable";
        }

        card.appendChild(price);

        // ---- Etsy link ----
        if (item.url) {
          const link = document.createElement("a");
          link.className = "listing-link";
          link.href = item.url;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = "View on Etsy";
          card.appendChild(link);
        }

        container.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      errorDiv.textContent = "Error loading Etsy listings.";
      container.textContent = "";
    }
  }

  loadListings();
</script>
